---
title: Larval thermal performance curves  
author: "AS Huffmyer"
date: '2021'
output:
  html_document:
    code_folding: hide
    toc: yes
    toc_depth: 6
    toc_float: yes
  pdf_document:
    keep_tex: yes
editor_options: 
  chunk_output_type: console
---
This script analyzes and plots data for Symbiontic Integration 2021 respirometry data for thermal performance curves.  

# **Setup**  

Set up workspace, set options, and load required packages.    
```{r}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

```{r, warning=FALSE, message=FALSE}
## install packages if you dont already have them in your library
if ("tidyverse" %in% rownames(installed.packages()) == 'FALSE') install.packages('tidyverse') 
if ("car" %in% rownames(installed.packages()) == 'FALSE') install.packages('car') 
#if ("lme4" %in% rownames(installed.packages()) == 'FALSE') install.packages('lme4') 
#if ("lmerTest" %in% rownames(installed.packages()) == 'FALSE') install.packages('lmerTest') 
if ("scales" %in% rownames(installed.packages()) == 'FALSE') install.packages('scales') 
if ("cowplot" %in% rownames(installed.packages()) == 'FALSE') install.packages('cowplot') 
if ("ggplot2" %in% rownames(installed.packages()) == 'FALSE') install.packages('ggplot2') 
#if ("effects" %in% rownames(installed.packages()) == 'FALSE') install.packages('effects') 
#if ("emmeans" %in% rownames(installed.packages()) == 'FALSE') install.packages('emmeans') 
#if ("multcomp" %in% rownames(installed.packages()) == 'FALSE') install.packages('multcomp') 
if ("nls.multstart" %in% rownames(installed.packages()) == 'FALSE') install.packages('nls.multstart') 
if ("broom" %in% rownames(installed.packages()) == 'FALSE') install.packages('broom') 
if ("rTPC" %in% rownames(installed.packages()) == 'FALSE') remotes::install_github("padpadpadpad/rTPC")

#load packages
library("ggplot2")
library("tidyverse")
library('car')
#library('lme4')
#library('lmerTest')
library('scales')
library('cowplot')
#library('effects')
#library('emmeans')
#library('multcomp')
library('nls.multstart')
library('broom')
library('rTPC')
```


# **Data visualization**  

Load data from LoLinR.    
```{r, warning=FALSE, message=FALSE}
PRdata<-read.csv("Pacu2021/Output/Respiration/TPC/oxygen_P_R_calc.csv") #load data
```

Format data columns.  
```{r, warning=FALSE, message=FALSE}
#remove all rows of wells that did not have samples or blanks
PRdata<-PRdata[!is.na(PRdata$Type),]

#format columns
PRdata$Temperature<-as.factor(PRdata$Temperature)
PRdata$Treatment<-as.factor(PRdata$Treatment)
PRdata$Plate<-as.factor(PRdata$Plate)
PRdata$Run<-as.factor(PRdata$Run)
```

View outliers.   
```{r, warning=FALSE, message=FALSE}
boxplot(PRdata$R.nmol.org.min)

PRdata <- PRdata %>% filter(R.nmol.org.min > -0.15) %>% filter(R.nmol.org.min < 0)

boxplot(PRdata$R.nmol.org.min)
```

# **Plotting**  

## Respiration  

Plot data as a dot plot with curves.   
```{r}

PRdata$Temperature<-as.numeric(as.character(PRdata$Temperature))
PRdata <- PRdata %>%
    group_by(Temperature)%>%
    filter(!Temperature==18)%>%
    filter(!Temperature==8)%>%
    #filter(R.nmol.org.min<0)%>%
    mutate(abs=abs(R.nmol.org.min))

r_plot<-PRdata %>%
    ggplot(., aes(x = Temperature, y = abs, colour=Treatment)) +
    geom_hline(yintercept=0, linetype="dashed", color="black", size=0.75)+
    #geom_boxplot(aes(fill=Treatment, group=interaction(Temperature, Treatment)), alpha=0.5)+
    geom_point(aes(fill=Treatment, group=interaction(Temperature, Treatment)), pch = 21, size=2, alpha=0.5, position = position_jitterdodge(0.3)) + 
   geom_smooth(method = "lm", se=FALSE, formula=y ~ poly(x, 3, raw=TRUE), size=3)+
    xlab("Temperature") + 
    scale_fill_manual(name="Treatment", values=c("blue","red"))+
    scale_color_manual(name="Treatment", values=c("blue","red"))+
    ylab(expression(bold(paste("R (nmol ", O[2], " larva"^-1, "min"^-1, ")")))) +
    #scale_y_continuous(limits=c(-0.2, 0.06), labels = scales::number_format(accuracy = 0.01, decimal.mark = '.'))+
    theme_classic() + 
    theme(
      legend.position="none",
      axis.title=element_text(face="bold", size=16),
      axis.text=element_text(size=12, color="black"), 
      legend.title=element_text(face="bold", size=14), 
      legend.text=element_text(size=12)
      ); r_plot

ggsave("Pacu2021/Figures/Respiration/TPC/Respiration.pdf", r_plot, dpi=300, w=8, h=8, units="in")
```

# **Analysis**    

## TPC ftting
#Padifeld et al **rTPC and nls.multstart: A new pipeline to fit thermal performance curves in r**
### https://besjournals.onlinelibrary.wiley.com/doi/full/10.1111/2041-210X.13585

```{r}
# AMBIENT CURVE FIT
d.amb <- PRdata %>% group_by(Temperature,Treatment)%>%
    summarise(rate=abs) %>%
  mutate(temp=Temperature) %>%
  filter(Treatment=="Ambient")

# choose model
get_model_names()
#sharpeschoolhigh_1981

# get start vals
amb.start_vals <- get_start_vals(d.amb$temp,d.amb$rate, model_name = 'sharpeschoolhigh_1981')
amb.start_vals

# get limits
amb.low_lims <- get_lower_lims(d.amb$temp,d.amb$rate, model_name = 'sharpeschoolhigh_1981')
amb.low_lims
amb.upper_lims <- get_upper_lims(d.amb$temp,d.amb$rate, model_name = 'sharpeschoolhigh_1981')
amb.start_vals
amb.low_lims
amb.upper_lims

amb.fit <- nls_multstart(rate~sharpeschoolhigh_1981(temp = temp, r_tref,e,eh,th, tref = 28),
                                                     data = d.amb,
                                                     iter = 500,
                                                     start_lower = amb.start_vals - 1,
                                                     start_upper = amb.start_vals + 1,
                                                     lower = amb.low_lims,
                                                     upper = amb.upper_lims,
                                                     supp_errors = 'Y')

amb.fit

# predict new data
amb_new_data <- data.frame(temp = seq(min(d.amb$temp), max(d.amb$temp), 0.5))
amb.preds <- augment(amb.fit, newdata = amb_new_data)

amb.TCP.res <- calc_params(amb.fit) %>%
  mutate_all(round, 2)   # round for easy viewing

amb.TCP.res 

```


# BOOTSTRAPPING AMBIENT CURVE FIT
```{r}
# refit model using nlsLM
fit_nlsLM <- minpack.lm::nlsLM(rate~sharpeschoolhigh_1981(temp = temp, r_tref,e,eh,th, tref = 28),
                        data = d.amb,
                        start = coef(amb.fit),
                        lower = amb.low_lims,
                        upper = amb.upper_lims,
                        weights = rep(1, times = nrow(d.amb)))

# bootstrap using case resampling
boot1 <- Boot(fit_nlsLM, method = 'case')

# look at the data
head(boot1$t)


# create predictions of each bootstrapped model
boot1_preds <- boot1$t %>%
  as.data.frame() %>%
  drop_na() %>%
  mutate(iter = 1:n()) %>%
  group_by_all() %>%
  do(data.frame(temp = seq(min(d.amb$temp), max(d.amb$temp), length.out = 100))) %>%
  ungroup() %>%
  mutate(pred = sharpeschoolhigh_1981(temp, r_tref, e, eh, th, tref = 28))

# calculate bootstrapped confidence intervals
boot1_conf_preds <- group_by(boot1_preds, temp) %>%
  summarise(conf_lower = quantile(pred, 0.025),
            conf_upper = quantile(pred, 0.975)) %>%
  ungroup()

# plot bootstrapped CIs
p1 <- ggplot() +
  geom_line(aes(temp, .fitted), amb.preds, col = 'blue') +
  geom_ribbon(aes(temp, ymin = conf_lower, ymax = conf_upper), boot1_conf_preds, fill = 'blue', alpha = 0.3) +
  geom_point(aes(temp, rate), d.amb, size = 2, alpha = 0.5,col = 'blue') +
  theme_bw(base_size = 12) +
  labs(x = 'Temperature (ºC)',
       y = 'Growth rate',
       title = 'Growth rate across temperatures')
p1

# # plot bootstrapped predictions
# p2 <- ggplot() +
#   geom_line(aes(temp, .fitted), amb.preds, col = 'blue') +
#   geom_line(aes(temp, pred, group = iter), boot1_preds, col = 'blue', alpha = 0.007) +
#   geom_point(aes(temp, rate), d.amb, size = 2, alpha = 0.5) +
#   theme_bw(base_size = 12) +
#   labs(x = 'Temperature (ºC)',
#        y = 'Growth rate',
#        title = 'Growth rate across temperatures')
# 
# p1 + p2

```













```{r}
# HIGH CURVE FIT
d.high <- PRdata %>% group_by(Temperature,Treatment)%>%
    summarise(rate=abs) %>%
  mutate(temp=Temperature) %>%
  filter(Treatment=="High")

# choose model
mod <- 'sharpschoolhigh_1981'

# get start vals
high.start_vals <- get_start_vals(d.high$temp,d.high$rate, model_name = 'sharpeschoolhigh_1981')
high.start_vals

# get limits
high.low_lims <- get_lower_lims(d.high$temp,d.high$rate, model_name = 'sharpeschoolhigh_1981')
high.low_lims
high.upper_lims <- get_upper_lims(d.high$temp,d.high$rate, model_name = 'sharpeschoolhigh_1981')
high.start_vals
high.low_lims
high.upper_lims

high.fit <- nls_multstart(rate~sharpeschoolhigh_1981(temp = temp, r_tref,e,eh,th, tref = 28),
                                                     data = d.high,
                                                     iter = 500,
                                                     start_lower = high.start_vals - 1,
                                                     start_upper = high.start_vals + 1,
                                                     lower = high.low_lims,
                                                     upper = high.upper_lims,
                                                     supp_errors = 'Y')

high.fit

amb.TCP.res <- calc_params(amb.fit) %>%
  mutate_all(round, 2)   # round for easy viewing

high.TCP.res <- calc_params(high.fit) %>%
  mutate_all(round, 2)   # round for easy viewing

amb.TCP.res
high.TCP.res

```


```{r}

# predict new data
amb_new_data <- data.frame(temp = seq(min(d.amb$temp), max(d.amb$temp), 0.5))
amb.preds <- augment(amb.fit, newdata = amb_new_data)

high_new_data <- data.frame(temp = seq(min(d.high$temp), max(d.high$temp), 0.5))
high.preds <- augment(high.fit, newdata = high_new_data)

dd <- PRdata %>% group_by(Temperature,Treatment)%>%
    summarise(rate=abs) %>%
  mutate(temp=Temperature)

# plot data and model fit
ggplot(dd,aes(temp, rate, color=Treatment)) +
  geom_point() +
  scale_color_manual(values=c('blue','red'))+
  geom_line(aes(temp, .fitted), amb.preds, col = 'blue', size=2) +
  geom_line(aes(temp, .fitted), high.preds, col = 'red', size=2) +
  theme_bw(base_size = 12) +
  labs(x = 'Temperature (ºC)',
       y = 'Metabolic rate',
       title = 'Respiration across temperatures')
```

#Bootstrapping the Curve Fit

```{r}












```
